---
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: master
  name: 04-accelerated-container-startup-master
spec:
  config:
    ignition:
      version: 3.2.0
    storage:
      files:
      - contents:
          source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKIwojIFRlbXBvcmFyaWx5IHJlc2V0IHRoZSBjb3JlIHN5c3RlbSBwcm9jZXNzZXMncyBDUFUgYWZmaW5pdHkgdG8gYmUgdW5yZXN0cmljdGVkIHRvIGFjY2VsZXJhdGUgc3RhcnR1cCBhbmQgc2h1dGRvd24KIwojIFRoZSBkZWZhdWx0cyBiZWxvdyBjYW4gYmUgb3ZlcnJpZGRlbiB2aWEgZW52aXJvbm1lbnQgdmFyaWFibGVzCiMKCiMgVGhlIGRlZmF1bHQgc2V0IG9mIGNyaXRpY2FsIHByb2Nlc3NlcyB3aG9zZSBhZmZpbml0eSBzaG91bGQgYmUgdGVtcG9yYXJpbHkgdW5ib3VuZDoKQ1JJVElDQUxfUFJPQ0VTU0VTPSR7Q1JJVElDQUxfUFJPQ0VTU0VTOi0ic3lzdGVtZCBvdnMgY3JpbyBrdWJlbGV0IE5ldHdvcmtNYW5hZ2VyIGNvbm1vbiBkYnVzIn0KCiMgRGVmYXVsdCB3YWl0IHRpbWUgaXMgNjAwcyA9IDEwbToKTUFYSU1VTV9XQUlUX1RJTUU9JHtNQVhJTVVNX1dBSVRfVElNRTotNjAwfQoKIyBEZWZhdWx0IHN0ZWFkeS1zdGF0ZSB0aHJlc2hvbGQgPSAyJQojIEFsbG93ZWQgdmFsdWVzOgojICA0ICAtIGFic29sdXRlIHBvZCBjb3VudCAoKy8tKQojICA0JSAtIHBlcmNlbnQgY2hhbmdlICgrLy0pCiMgIC0xIC0gZGlzYWJsZSB0aGUgc3RlYWR5LXN0YXRlIGNoZWNrClNURUFEWV9TVEFURV9USFJFU0hPTEQ9JHtTVEVBRFlfU1RBVEVfVEhSRVNIT0xEOi0yJX0KCiMgRGVmYXVsdCBzdGVhZHktc3RhdGUgd2luZG93ID0gNjBzCiMgSWYgdGhlIHJ1bm5pbmcgcG9kIGNvdW50IHN0YXlzIHdpdGhpbiB0aGUgZ2l2ZW4gdGhyZXNob2xkIGZvciB0aGlzIHRpbWUKIyBwZXJpb2QsIHJldHVybiBDUFUgdXRpbGl6YXRpb24gdG8gbm9ybWFsIGJlZm9yZSB0aGUgbWF4aW11bSB3YWl0IHRpbWUgaGFzCiMgZXhwaXJlcwpTVEVBRFlfU1RBVEVfV0lORE9XPSR7U1RFQURZX1NUQVRFX1dJTkRPVzotNjB9CgojIERlZmF1bHQgc3RlYWR5LXN0YXRlIGRvZXMgbm90IGFsbG93IDAgdG8gY291bnQKU1RFQURZX1NUQVRFX0FMTE9XX1pFUk89MAoKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwoKdW5yZXN0cmljdGVkQ3B1c2V0KCkgewogIGlmIFtbICEgLWUgL3Zhci9saWIva3ViZWxldC9jcHVfbWFuYWdlcl9zdGF0ZSBdXTsgdGhlbgogICAgIyB1c2UgYWxsIHRoZSBjcHVzIGlmIGt1YmVsZXQgaXMgbm90IGNvbmZpZ3VyZWQgeWV0CiAgICBjYXQgL3N5cy9mcy9jZ3JvdXAvY3B1c2V0L2NwdXNldC5jcHVzCiAgZWxzZQogICAganEgLXIgJy5kZWZhdWx0Q3B1U2V0JyA8L3Zhci9saWIva3ViZWxldC9jcHVfbWFuYWdlcl9zdGF0ZQogIGZpCn0KCnJlc3RyaWN0ZWRDcHVzZXQoKSB7CiAgZm9yIGFyZyBpbiAkKDwvcHJvYy9jbWRsaW5lKTsgZG8KICAgIGlmIFtbICRhcmcgPX4gXnN5c3RlbWQuY3B1X2FmZmluaXR5PSBdXTsgdGhlbgogICAgICBlY2hvICR7YXJnIyo9fQogICAgICByZXR1cm4gMAogICAgZmkKICBkb25lCiAgcmV0dXJuIDEKfQoKcmVzZXRBZmZpbml0eSgpIHsKICBsb2NhbCBjcHVzZXQ9IiQxIgogIGxvY2FsIGZhaWxjb3VudD0wCiAgbG9jYWwgc3VjY2Vzc2NvdW50PTAKICBsb2dnZXIgIlJlY292ZXJ5OiBTZXR0aW5nIENQVSBhZmZpbml0eSBmb3IgY3JpdGljYWwgcHJvY2Vzc2VzIFwiJENSSVRJQ0FMX1BST0NFU1NFU1wiIHRvICRjcHVzZXQiCiAgZm9yIHByb2MgaW4gJENSSVRJQ0FMX1BST0NFU1NFUzsgZG8KICAgIGxvY2FsIHBpZHM9IiQocGdyZXAgJHByb2MpIgogICAgZm9yIHBpZCBpbiAkcGlkczsgZG8KICAgICAgbG9jYWwgdGFza3NldE91dHB1dAogICAgICB0YXNrc2V0T3V0cHV0PSIkKHRhc2tzZXQgLWFwYyAiJGNwdXNldCIgJHBpZCAyPiYxKSIKICAgICAgaWYgW1sgJD8gLW5lIDAgXV07IHRoZW4KICAgICAgICBlY2hvICJFUlJPUjogJHRhc2tzZXRPdXRwdXQiCiAgICAgICAgKChmYWlsY291bnQrKykpCiAgICAgIGVsc2UKICAgICAgICAoKHN1Y2Nlc3Njb3VudCsrKSkKICAgICAgZmkKICAgIGRvbmUKICBkb25lCiAgbG9nZ2VyICJSZWNvdmVyeTogUmUtYWZmaW5lZCAkc3VjY2Vzc2NvdW50IHBpZHMgc3VjY2Vzc2Z1bGx5IgogIGlmIFtbICRmYWlsY291bnQgLWd0IDAgXV07IHRoZW4KICAgIGxvZ2dlciAiUmVjb3Zlcnk6IEZhaWxlZCB0byByZS1hZmZpbmUgJGZhaWxjb3VudCBwcm9jZXNzZXMiCiAgICByZXR1cm4gMQogIGZpCn0KCnNldFVucmVzdHJpY3RlZCgpIHsKICBsb2dnZXIgIlJlY292ZXJ5OiBTZXR0aW5nIGNyaXRpY2FsIHN5c3RlbSBwcm9jZXNzZXMgdG8gaGF2ZSB1bnJlc3RyaWN0ZWQgQ1BVIGFjY2VzcyIKICByZXNldEFmZmluaXR5ICIkKHVucmVzdHJpY3RlZENwdXNldCkiCn0KCnNldFJlc3RyaWN0ZWQoKSB7CiAgbG9nZ2VyICJSZWNvdmVyeTogUmVzZXR0aW5nIGNyaXRpY2FsIHN5c3RlbSBwcm9jZXNzZXMgYmFjayB0byBub3JtYWxseSByZXN0cmljdGVkIGFjY2VzcyIKICByZXNldEFmZmluaXR5ICIkKHJlc3RyaWN0ZWRDcHVzZXQpIgp9CgpjdXJyZW50QWZmaW5pdHkoKSB7CiAgbG9jYWwgcGlkPSIkMSIKICB0YXNrc2V0IC1wYyAkcGlkIHwgYXdrIC1GJzogJyAne3ByaW50ICQyfScKfQoKd2l0aGluKCkgewogIGxvY2FsIGxhc3Q9JDEgY3VycmVudD0kMiB0aHJlc2hvbGQ9JDMKICBsb2NhbCBkZWx0YT0wIHBjaGFuZ2UKICBkZWx0YT0kKCggY3VycmVudCAtIGxhc3QgKSkKICBpZiBbWyAkY3VycmVudCAtZXEgJGxhc3QgXV07IHRoZW4KICAgIHBjaGFuZ2U9MAogIGVsaWYgW1sgJGxhc3QgLWVxIDAgXV07IHRoZW4KICAgIHBjaGFuZ2U9MTAwMDAwMAogIGVsc2UKICAgIHBjaGFuZ2U9JCgoICggJGRlbHRhICogMTAwKSAvIGxhc3QgKSkKICBmaQogIGVjaG8gLW4gImxhc3Q6JGxhc3QgY3VycmVudDokY3VycmVudCBkZWx0YTokZGVsdGEgcGNoYW5nZToke3BjaGFuZ2V9JTogIgogIGxvY2FsIGFic29sdXRlIGxpbWl0CiAgY2FzZSAkdGhyZXNob2xkIGluCiAgICAqJSkKICAgICAgYWJzb2x1dGU9JHtwY2hhbmdlIyMtfSAjIGFic29sdXRlIHZhbHVlCiAgICAgIGxpbWl0PSR7dGhyZXNob2xkJSUlfQogICAgICA7OwogICAgKikKICAgICAgYWJzb2x1dGU9JHtkZWx0YSMjLX0gIyBhYnNvbHV0ZSB2YWx1ZQogICAgICBsaW1pdD0kdGhyZXNob2xkCiAgICAgIDs7CiAgZXNhYwogIGlmIFtbICRhYnNvbHV0ZSAtbHQgJGxpbWl0IF1dOyB0aGVuCiAgICBlY2hvICJ3aXRoaW4gKCsvLSkkdGhyZXNob2xkIgogICAgcmV0dXJuIDAKICBlbHNlCiAgICBlY2hvICJvdXRzaWRlICgrLy0pJHRocmVzaG9sZCIKICAgIHJldHVybiAxCiAgZmkKfQoKc3RlYWR5c3RhdGUoKSB7CiAgbG9jYWwgbGFzdD0kMSBjdXJyZW50PSQyCiAgaWYgW1sgJFNURUFEWV9TVEFURV9BTExPV1NfWkVSTyAtZXEgMCAmJiAkY3VycmVudCAtZXEgMCBdXTsgdGhlbgogICAgZWNobyAiV2FpdGluZyBmb3IgYSBub24temVybyBjb3VudCBiZWZvcmUgY2hlY2tpbmcgZm9yIHN0ZWFkeS1zdGF0ZSIKICAgIHJldHVybiAxCiAgZmkKICB3aXRoaW4gJGxhc3QgJGN1cnJlbnQgJFNURUFEWV9TVEFURV9USFJFU0hPTEQKfQoKd2FpdEZvclJlYWR5KCkgewogIGxvZ2dlciAiUmVjb3Zlcnk6IFdhaXRpbmcgJHtNQVhJTVVNX1dBSVRfVElNRX1zIGZvciB0aGUgaW5pdGlhbGl6YXRpb24gdG8gY29tcGxldGUiCiAgbG9jYWwgbGFzdFN5c3RlbWRDcHVzZXQ9IiQoY3VycmVudEFmZmluaXR5IDEpIgogIGxvY2FsIGxhc3REZXNpcmVkQ3B1c2V0PSIkKHVucmVzdHJpY3RlZENwdXNldCkiCiAgbG9jYWwgdD0wIHM9MTAKICBsb2NhbCBsYXN0Q2NvdW50PTAgY2NvdW50PTAgc3RlYWR5U3RhdGVUaW1lPTAKICB3aGlsZSBbWyAkdCAtbHQgJE1BWElNVU1fV0FJVF9USU1FIF1dOyBkbwogICAgc2xlZXAgJHMKICAgICgodCArPSBzKSkKICAgICMgUmUtY2hlY2sgdGhlIGN1cnJlbnQgYWZmaW5pdHkgb2Ygc3lzdGVtZCwgaW4gY2FzZSBzb21lIG90aGVyIHByb2Nlc3MgaGFzIGNoYW5nZWQgaXQKICAgIGxvY2FsIHN5c3RlbWRDcHVzZXQ9IiQoY3VycmVudEFmZmluaXR5IDEpIgogICAgIyBSZS1jaGVjayB0aGUgdW5yZXN0cmljdGVkIENwdXNldCwgYXMgdGhlIGFsbG93ZWQgc2V0IG9mIHVucmVzZXJ2ZWQgY29yZXMgbWF5IGNoYW5nZSBhcyBwb2RzIGFyZSBhc3NpZ25lZCB0byBjb3JlcwogICAgbG9jYWwgZGVzaXJlZENwdXNldD0iJCh1bnJlc3RyaWN0ZWRDcHVzZXQpIgogICAgaWYgW1sgJHN5c3RlbWRDcHVzZXQgIT0gJGxhc3RTeXN0ZW1kQ3B1c2V0IHx8ICRsYXN0RGVzaXJlZENwdXNldCAhPSAkZGVzaXJlZENwdXNldCBdXTsgdGhlbgogICAgICByZXNldEFmZmluaXR5ICIkZGVzaXJlZENwdXNldCIKICAgICAgbGFzdFN5c3RlbWRDcHVzZXQ9IiQoY3VycmVudEFmZmluaXR5IDEpIgogICAgICBsYXN0RGVzaXJlZENwdXNldD0iJGRlc2lyZWRDcHVzZXQiCiAgICBmaQoKICAgICMgRGV0ZWN0IHN0ZWFkeS1zdGF0ZSBwb2QgY291bnQKICAgIGNjb3VudD0kKGNyaWN0bCBwcyB8IHdjIC1sKQogICAgaWYgc3RlYWR5c3RhdGUgJGxhc3RDY291bnQgJGNjb3VudDsgdGhlbgogICAgICAoKHN0ZWFkeVN0YXRlVGltZSArPSBzKSkKICAgICAgZWNobyAiU3RlYWR5LXN0YXRlIGZvciAke3N0ZWFkeVN0YXRlVGltZX1zLyR7U1RFQURZX1NUQVRFX1dJTkRPV31zIgogICAgICBpZiBbWyAkc3RlYWR5U3RhdGVUaW1lIC1nZSAkU1RFQURZX1NUQVRFX1dJTkRPVyBdXTsgdGhlbgogICAgICAgIGxvZ2dlciAiUmVjb3Zlcnk6IFN0ZWFkeS1zdGF0ZSAoKy8tICRTVEVBRFlfU1RBVEVfVEhSRVNIT0xEKSBmb3IgJHtTVEVBRFlfU1RBVEVfV0lORE9XfXM6IERvbmUiCiAgICAgICAgcmV0dXJuIDAKICAgICAgZmkKICAgIGVsc2UKICAgICAgaWYgW1sgJHN0ZWFkeVN0YXRlVGltZSAtZ3QgMCBdXTsgdGhlbgogICAgICAgIGVjaG8gIlJlc2V0dGluZyBzdGVhZHktc3RhdGUgdGltZXIiCiAgICAgICAgc3RlYWR5U3RhdGVUaW1lPTAKICAgICAgZmkKICAgIGZpCiAgICBsYXN0Q2NvdW50PSRjY291bnQKICBkb25lCiAgbG9nZ2VyICJSZWNvdmVyeTogUmVjb3ZlcnkgQ29tcGxldGUgVGltZW91dCIKfQoKbWFpbigpIHsKICBpZiAhIHVucmVzdHJpY3RlZENwdXNldCA+Ji9kZXYvbnVsbDsgdGhlbgogICAgbG9nZ2VyICJSZWNvdmVyeTogTm8gdW5yZXN0cmljdGVkIENwdXNldCBjb3VsZCBiZSBkZXRlY3RlZCIKICAgIHJldHVybiAxCiAgZmkKCiAgaWYgISByZXN0cmljdGVkQ3B1c2V0ID4mL2Rldi9udWxsOyB0aGVuCiAgICBsb2dnZXIgIlJlY292ZXJ5OiBObyByZXN0cmljdGVkIENwdXNldCBoYXMgYmVlbiBjb25maWd1cmVkLiAgV2UgYXJlIGFscmVhZHkgcnVubmluZyB1bnJlc3RyaWN0ZWQuIgogICAgcmV0dXJuIDAKICBmaQoKICAjIEVuc3VyZSB3ZSByZXNldCB0aGUgQ1BVIGFmZmluaXR5IHdoZW4gd2UgZXhpdCB0aGlzIHNjcmlwdCBmb3IgYW55IHJlYXNvbgogICMgVGhpcyB3YXkgZWl0aGVyIGFmdGVyIHRoZSB0aW1lciBleHBpcmVzIG9yIGFmdGVyIHRoZSBwcm9jZXNzIGlzIGludGVycnVwdGVkCiAgIyB2aWEgXkMgb3IgU0lHVEVSTSwgd2UgcmV0dXJuIHRoaW5ncyBiYWNrIHRvIHRoZSB3YXkgdGhleSBzaG91bGQgYmUuCiAgdHJhcCBzZXRSZXN0cmljdGVkIEVYSVQKCiAgbG9nZ2VyICJSZWNvdmVyeTogUmVjb3ZlcnkgTW9kZSBTdGFydGluZyIKICBzZXRVbnJlc3RyaWN0ZWQKICB3YWl0Rm9yUmVhZHkKfQoKaWYgW1sgIiR7QkFTSF9TT1VSQ0VbMF19IiA9ICIkezB9IiBdXTsgdGhlbgogIG1haW4gIiR7QH0iCiAgZXhpdCAkPwpmaQo=
        mode: 493
        path: /usr/local/bin/accelerated-container-startup.sh
    systemd:
      units:
      - contents: |
          [Unit]
          Description=Unlocks more CPUs for critical system processes during container startup

          [Service]
          Type=simple
          ExecStart=/usr/local/bin/accelerated-container-startup.sh

          # Maximum wait time is 600s = 10m:
          Environment=MAXIMUM_WAIT_TIME=600

          # Steady-state threshold = 2%
          # Allowed values:
          #  4  - absolute pod count (+/-)
          #  4% - percent change (+/-)
          #  -1 - disable the steady-state check
          Environment=STEADY_STATE_THRESHOLD=2%%

          # Steady-state window = 60s
          # If the running pod count stays within the given threshold for this time
          # period, return CPU utilization to normal before the maximum wait time has
          # expires
          Environment=STEADY_STATE_WINDOW=60

          [Install]
          WantedBy=multi-user.target
        enabled: true
        name: accelerated-container-startup.service
      - contents: |
          [Unit]
          Description=Unlocks more CPUs for critical system processes during container shutdown
          DefaultDependencies=no

          [Service]
          Type=simple
          ExecStart=/usr/local/bin/accelerated-container-startup.sh

          # Maximum wait time is 600s = 10m:
          Environment=MAXIMUM_WAIT_TIME=600

          # Steady-state threshold
          # Allowed values:
          #  4  - absolute pod count (+/-)
          #  4% - percent change (+/-)
          #  -1 - disable the steady-state check
          Environment=STEADY_STATE_THRESHOLD=-1

          # Steady-state window = 60s
          # If the running pod count stays within the given threshold for this time
          # period, return CPU utilization to normal before the maximum wait time has
          # expires
          Environment=STEADY_STATE_WINDOW=60

          [Install]
          WantedBy=shutdown.target reboot.target halt.target
        enabled: true
        name: accelerated-container-shutdown.service
---
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: worker
  name: 04-accelerated-container-startup-worker
spec:
  config:
    ignition:
      version: 3.2.0
    storage:
      files:
      - contents:
          source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKIwojIFRlbXBvcmFyaWx5IHJlc2V0IHRoZSBjb3JlIHN5c3RlbSBwcm9jZXNzZXMncyBDUFUgYWZmaW5pdHkgdG8gYmUgdW5yZXN0cmljdGVkIHRvIGFjY2VsZXJhdGUgc3RhcnR1cCBhbmQgc2h1dGRvd24KIwojIFRoZSBkZWZhdWx0cyBiZWxvdyBjYW4gYmUgb3ZlcnJpZGRlbiB2aWEgZW52aXJvbm1lbnQgdmFyaWFibGVzCiMKCiMgVGhlIGRlZmF1bHQgc2V0IG9mIGNyaXRpY2FsIHByb2Nlc3NlcyB3aG9zZSBhZmZpbml0eSBzaG91bGQgYmUgdGVtcG9yYXJpbHkgdW5ib3VuZDoKQ1JJVElDQUxfUFJPQ0VTU0VTPSR7Q1JJVElDQUxfUFJPQ0VTU0VTOi0ic3lzdGVtZCBvdnMgY3JpbyBrdWJlbGV0IE5ldHdvcmtNYW5hZ2VyIGNvbm1vbiBkYnVzIn0KCiMgRGVmYXVsdCB3YWl0IHRpbWUgaXMgNjAwcyA9IDEwbToKTUFYSU1VTV9XQUlUX1RJTUU9JHtNQVhJTVVNX1dBSVRfVElNRTotNjAwfQoKIyBEZWZhdWx0IHN0ZWFkeS1zdGF0ZSB0aHJlc2hvbGQgPSAyJQojIEFsbG93ZWQgdmFsdWVzOgojICA0ICAtIGFic29sdXRlIHBvZCBjb3VudCAoKy8tKQojICA0JSAtIHBlcmNlbnQgY2hhbmdlICgrLy0pCiMgIC0xIC0gZGlzYWJsZSB0aGUgc3RlYWR5LXN0YXRlIGNoZWNrClNURUFEWV9TVEFURV9USFJFU0hPTEQ9JHtTVEVBRFlfU1RBVEVfVEhSRVNIT0xEOi0yJX0KCiMgRGVmYXVsdCBzdGVhZHktc3RhdGUgd2luZG93ID0gNjBzCiMgSWYgdGhlIHJ1bm5pbmcgcG9kIGNvdW50IHN0YXlzIHdpdGhpbiB0aGUgZ2l2ZW4gdGhyZXNob2xkIGZvciB0aGlzIHRpbWUKIyBwZXJpb2QsIHJldHVybiBDUFUgdXRpbGl6YXRpb24gdG8gbm9ybWFsIGJlZm9yZSB0aGUgbWF4aW11bSB3YWl0IHRpbWUgaGFzCiMgZXhwaXJlcwpTVEVBRFlfU1RBVEVfV0lORE9XPSR7U1RFQURZX1NUQVRFX1dJTkRPVzotNjB9CgojIERlZmF1bHQgc3RlYWR5LXN0YXRlIGRvZXMgbm90IGFsbG93IDAgdG8gY291bnQKU1RFQURZX1NUQVRFX0FMTE9XX1pFUk89MAoKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwoKdW5yZXN0cmljdGVkQ3B1c2V0KCkgewogIGlmIFtbICEgLWUgL3Zhci9saWIva3ViZWxldC9jcHVfbWFuYWdlcl9zdGF0ZSBdXTsgdGhlbgogICAgIyB1c2UgYWxsIHRoZSBjcHVzIGlmIGt1YmVsZXQgaXMgbm90IGNvbmZpZ3VyZWQgeWV0CiAgICBjYXQgL3N5cy9mcy9jZ3JvdXAvY3B1c2V0L2NwdXNldC5jcHVzCiAgZWxzZQogICAganEgLXIgJy5kZWZhdWx0Q3B1U2V0JyA8L3Zhci9saWIva3ViZWxldC9jcHVfbWFuYWdlcl9zdGF0ZQogIGZpCn0KCnJlc3RyaWN0ZWRDcHVzZXQoKSB7CiAgZm9yIGFyZyBpbiAkKDwvcHJvYy9jbWRsaW5lKTsgZG8KICAgIGlmIFtbICRhcmcgPX4gXnN5c3RlbWQuY3B1X2FmZmluaXR5PSBdXTsgdGhlbgogICAgICBlY2hvICR7YXJnIyo9fQogICAgICByZXR1cm4gMAogICAgZmkKICBkb25lCiAgcmV0dXJuIDEKfQoKcmVzZXRBZmZpbml0eSgpIHsKICBsb2NhbCBjcHVzZXQ9IiQxIgogIGxvY2FsIGZhaWxjb3VudD0wCiAgbG9jYWwgc3VjY2Vzc2NvdW50PTAKICBsb2dnZXIgIlJlY292ZXJ5OiBTZXR0aW5nIENQVSBhZmZpbml0eSBmb3IgY3JpdGljYWwgcHJvY2Vzc2VzIFwiJENSSVRJQ0FMX1BST0NFU1NFU1wiIHRvICRjcHVzZXQiCiAgZm9yIHByb2MgaW4gJENSSVRJQ0FMX1BST0NFU1NFUzsgZG8KICAgIGxvY2FsIHBpZHM9IiQocGdyZXAgJHByb2MpIgogICAgZm9yIHBpZCBpbiAkcGlkczsgZG8KICAgICAgbG9jYWwgdGFza3NldE91dHB1dAogICAgICB0YXNrc2V0T3V0cHV0PSIkKHRhc2tzZXQgLWFwYyAiJGNwdXNldCIgJHBpZCAyPiYxKSIKICAgICAgaWYgW1sgJD8gLW5lIDAgXV07IHRoZW4KICAgICAgICBlY2hvICJFUlJPUjogJHRhc2tzZXRPdXRwdXQiCiAgICAgICAgKChmYWlsY291bnQrKykpCiAgICAgIGVsc2UKICAgICAgICAoKHN1Y2Nlc3Njb3VudCsrKSkKICAgICAgZmkKICAgIGRvbmUKICBkb25lCiAgbG9nZ2VyICJSZWNvdmVyeTogUmUtYWZmaW5lZCAkc3VjY2Vzc2NvdW50IHBpZHMgc3VjY2Vzc2Z1bGx5IgogIGlmIFtbICRmYWlsY291bnQgLWd0IDAgXV07IHRoZW4KICAgIGxvZ2dlciAiUmVjb3Zlcnk6IEZhaWxlZCB0byByZS1hZmZpbmUgJGZhaWxjb3VudCBwcm9jZXNzZXMiCiAgICByZXR1cm4gMQogIGZpCn0KCnNldFVucmVzdHJpY3RlZCgpIHsKICBsb2dnZXIgIlJlY292ZXJ5OiBTZXR0aW5nIGNyaXRpY2FsIHN5c3RlbSBwcm9jZXNzZXMgdG8gaGF2ZSB1bnJlc3RyaWN0ZWQgQ1BVIGFjY2VzcyIKICByZXNldEFmZmluaXR5ICIkKHVucmVzdHJpY3RlZENwdXNldCkiCn0KCnNldFJlc3RyaWN0ZWQoKSB7CiAgbG9nZ2VyICJSZWNvdmVyeTogUmVzZXR0aW5nIGNyaXRpY2FsIHN5c3RlbSBwcm9jZXNzZXMgYmFjayB0byBub3JtYWxseSByZXN0cmljdGVkIGFjY2VzcyIKICByZXNldEFmZmluaXR5ICIkKHJlc3RyaWN0ZWRDcHVzZXQpIgp9CgpjdXJyZW50QWZmaW5pdHkoKSB7CiAgbG9jYWwgcGlkPSIkMSIKICB0YXNrc2V0IC1wYyAkcGlkIHwgYXdrIC1GJzogJyAne3ByaW50ICQyfScKfQoKd2l0aGluKCkgewogIGxvY2FsIGxhc3Q9JDEgY3VycmVudD0kMiB0aHJlc2hvbGQ9JDMKICBsb2NhbCBkZWx0YT0wIHBjaGFuZ2UKICBkZWx0YT0kKCggY3VycmVudCAtIGxhc3QgKSkKICBpZiBbWyAkY3VycmVudCAtZXEgJGxhc3QgXV07IHRoZW4KICAgIHBjaGFuZ2U9MAogIGVsaWYgW1sgJGxhc3QgLWVxIDAgXV07IHRoZW4KICAgIHBjaGFuZ2U9MTAwMDAwMAogIGVsc2UKICAgIHBjaGFuZ2U9JCgoICggJGRlbHRhICogMTAwKSAvIGxhc3QgKSkKICBmaQogIGVjaG8gLW4gImxhc3Q6JGxhc3QgY3VycmVudDokY3VycmVudCBkZWx0YTokZGVsdGEgcGNoYW5nZToke3BjaGFuZ2V9JTogIgogIGxvY2FsIGFic29sdXRlIGxpbWl0CiAgY2FzZSAkdGhyZXNob2xkIGluCiAgICAqJSkKICAgICAgYWJzb2x1dGU9JHtwY2hhbmdlIyMtfSAjIGFic29sdXRlIHZhbHVlCiAgICAgIGxpbWl0PSR7dGhyZXNob2xkJSUlfQogICAgICA7OwogICAgKikKICAgICAgYWJzb2x1dGU9JHtkZWx0YSMjLX0gIyBhYnNvbHV0ZSB2YWx1ZQogICAgICBsaW1pdD0kdGhyZXNob2xkCiAgICAgIDs7CiAgZXNhYwogIGlmIFtbICRhYnNvbHV0ZSAtbHQgJGxpbWl0IF1dOyB0aGVuCiAgICBlY2hvICJ3aXRoaW4gKCsvLSkkdGhyZXNob2xkIgogICAgcmV0dXJuIDAKICBlbHNlCiAgICBlY2hvICJvdXRzaWRlICgrLy0pJHRocmVzaG9sZCIKICAgIHJldHVybiAxCiAgZmkKfQoKc3RlYWR5c3RhdGUoKSB7CiAgbG9jYWwgbGFzdD0kMSBjdXJyZW50PSQyCiAgaWYgW1sgJFNURUFEWV9TVEFURV9BTExPV1NfWkVSTyAtZXEgMCAmJiAkY3VycmVudCAtZXEgMCBdXTsgdGhlbgogICAgZWNobyAiV2FpdGluZyBmb3IgYSBub24temVybyBjb3VudCBiZWZvcmUgY2hlY2tpbmcgZm9yIHN0ZWFkeS1zdGF0ZSIKICAgIHJldHVybiAxCiAgZmkKICB3aXRoaW4gJGxhc3QgJGN1cnJlbnQgJFNURUFEWV9TVEFURV9USFJFU0hPTEQKfQoKd2FpdEZvclJlYWR5KCkgewogIGxvZ2dlciAiUmVjb3Zlcnk6IFdhaXRpbmcgJHtNQVhJTVVNX1dBSVRfVElNRX1zIGZvciB0aGUgaW5pdGlhbGl6YXRpb24gdG8gY29tcGxldGUiCiAgbG9jYWwgbGFzdFN5c3RlbWRDcHVzZXQ9IiQoY3VycmVudEFmZmluaXR5IDEpIgogIGxvY2FsIGxhc3REZXNpcmVkQ3B1c2V0PSIkKHVucmVzdHJpY3RlZENwdXNldCkiCiAgbG9jYWwgdD0wIHM9MTAKICBsb2NhbCBsYXN0Q2NvdW50PTAgY2NvdW50PTAgc3RlYWR5U3RhdGVUaW1lPTAKICB3aGlsZSBbWyAkdCAtbHQgJE1BWElNVU1fV0FJVF9USU1FIF1dOyBkbwogICAgc2xlZXAgJHMKICAgICgodCArPSBzKSkKICAgICMgUmUtY2hlY2sgdGhlIGN1cnJlbnQgYWZmaW5pdHkgb2Ygc3lzdGVtZCwgaW4gY2FzZSBzb21lIG90aGVyIHByb2Nlc3MgaGFzIGNoYW5nZWQgaXQKICAgIGxvY2FsIHN5c3RlbWRDcHVzZXQ9IiQoY3VycmVudEFmZmluaXR5IDEpIgogICAgIyBSZS1jaGVjayB0aGUgdW5yZXN0cmljdGVkIENwdXNldCwgYXMgdGhlIGFsbG93ZWQgc2V0IG9mIHVucmVzZXJ2ZWQgY29yZXMgbWF5IGNoYW5nZSBhcyBwb2RzIGFyZSBhc3NpZ25lZCB0byBjb3JlcwogICAgbG9jYWwgZGVzaXJlZENwdXNldD0iJCh1bnJlc3RyaWN0ZWRDcHVzZXQpIgogICAgaWYgW1sgJHN5c3RlbWRDcHVzZXQgIT0gJGxhc3RTeXN0ZW1kQ3B1c2V0IHx8ICRsYXN0RGVzaXJlZENwdXNldCAhPSAkZGVzaXJlZENwdXNldCBdXTsgdGhlbgogICAgICByZXNldEFmZmluaXR5ICIkZGVzaXJlZENwdXNldCIKICAgICAgbGFzdFN5c3RlbWRDcHVzZXQ9IiQoY3VycmVudEFmZmluaXR5IDEpIgogICAgICBsYXN0RGVzaXJlZENwdXNldD0iJGRlc2lyZWRDcHVzZXQiCiAgICBmaQoKICAgICMgRGV0ZWN0IHN0ZWFkeS1zdGF0ZSBwb2QgY291bnQKICAgIGNjb3VudD0kKGNyaWN0bCBwcyB8IHdjIC1sKQogICAgaWYgc3RlYWR5c3RhdGUgJGxhc3RDY291bnQgJGNjb3VudDsgdGhlbgogICAgICAoKHN0ZWFkeVN0YXRlVGltZSArPSBzKSkKICAgICAgZWNobyAiU3RlYWR5LXN0YXRlIGZvciAke3N0ZWFkeVN0YXRlVGltZX1zLyR7U1RFQURZX1NUQVRFX1dJTkRPV31zIgogICAgICBpZiBbWyAkc3RlYWR5U3RhdGVUaW1lIC1nZSAkU1RFQURZX1NUQVRFX1dJTkRPVyBdXTsgdGhlbgogICAgICAgIGxvZ2dlciAiUmVjb3Zlcnk6IFN0ZWFkeS1zdGF0ZSAoKy8tICRTVEVBRFlfU1RBVEVfVEhSRVNIT0xEKSBmb3IgJHtTVEVBRFlfU1RBVEVfV0lORE9XfXM6IERvbmUiCiAgICAgICAgcmV0dXJuIDAKICAgICAgZmkKICAgIGVsc2UKICAgICAgaWYgW1sgJHN0ZWFkeVN0YXRlVGltZSAtZ3QgMCBdXTsgdGhlbgogICAgICAgIGVjaG8gIlJlc2V0dGluZyBzdGVhZHktc3RhdGUgdGltZXIiCiAgICAgICAgc3RlYWR5U3RhdGVUaW1lPTAKICAgICAgZmkKICAgIGZpCiAgICBsYXN0Q2NvdW50PSRjY291bnQKICBkb25lCiAgbG9nZ2VyICJSZWNvdmVyeTogUmVjb3ZlcnkgQ29tcGxldGUgVGltZW91dCIKfQoKbWFpbigpIHsKICBpZiAhIHVucmVzdHJpY3RlZENwdXNldCA+Ji9kZXYvbnVsbDsgdGhlbgogICAgbG9nZ2VyICJSZWNvdmVyeTogTm8gdW5yZXN0cmljdGVkIENwdXNldCBjb3VsZCBiZSBkZXRlY3RlZCIKICAgIHJldHVybiAxCiAgZmkKCiAgaWYgISByZXN0cmljdGVkQ3B1c2V0ID4mL2Rldi9udWxsOyB0aGVuCiAgICBsb2dnZXIgIlJlY292ZXJ5OiBObyByZXN0cmljdGVkIENwdXNldCBoYXMgYmVlbiBjb25maWd1cmVkLiAgV2UgYXJlIGFscmVhZHkgcnVubmluZyB1bnJlc3RyaWN0ZWQuIgogICAgcmV0dXJuIDAKICBmaQoKICAjIEVuc3VyZSB3ZSByZXNldCB0aGUgQ1BVIGFmZmluaXR5IHdoZW4gd2UgZXhpdCB0aGlzIHNjcmlwdCBmb3IgYW55IHJlYXNvbgogICMgVGhpcyB3YXkgZWl0aGVyIGFmdGVyIHRoZSB0aW1lciBleHBpcmVzIG9yIGFmdGVyIHRoZSBwcm9jZXNzIGlzIGludGVycnVwdGVkCiAgIyB2aWEgXkMgb3IgU0lHVEVSTSwgd2UgcmV0dXJuIHRoaW5ncyBiYWNrIHRvIHRoZSB3YXkgdGhleSBzaG91bGQgYmUuCiAgdHJhcCBzZXRSZXN0cmljdGVkIEVYSVQKCiAgbG9nZ2VyICJSZWNvdmVyeTogUmVjb3ZlcnkgTW9kZSBTdGFydGluZyIKICBzZXRVbnJlc3RyaWN0ZWQKICB3YWl0Rm9yUmVhZHkKfQoKaWYgW1sgIiR7QkFTSF9TT1VSQ0VbMF19IiA9ICIkezB9IiBdXTsgdGhlbgogIG1haW4gIiR7QH0iCiAgZXhpdCAkPwpmaQo=
        mode: 493
        path: /usr/local/bin/accelerated-container-startup.sh
    systemd:
      units:
      - contents: |
          [Unit]
          Description=Unlocks more CPUs for critical system processes during container startup

          [Service]
          Type=simple
          ExecStart=/usr/local/bin/accelerated-container-startup.sh

          # Maximum wait time is 600s = 10m:
          Environment=MAXIMUM_WAIT_TIME=600

          # Steady-state threshold = 2%
          # Allowed values:
          #  4  - absolute pod count (+/-)
          #  4% - percent change (+/-)
          #  -1 - disable the steady-state check
          Environment=STEADY_STATE_THRESHOLD=2%%

          # Steady-state window = 60s
          # If the running pod count stays within the given threshold for this time
          # period, return CPU utilization to normal before the maximum wait time has
          # expires
          Environment=STEADY_STATE_WINDOW=60

          [Install]
          WantedBy=multi-user.target
        enabled: true
        name: accelerated-container-startup.service
      - contents: |
          [Unit]
          Description=Unlocks more CPUs for critical system processes during container shutdown
          DefaultDependencies=no

          [Service]
          Type=simple
          ExecStart=/usr/local/bin/accelerated-container-startup.sh

          # Maximum wait time is 600s = 10m:
          Environment=MAXIMUM_WAIT_TIME=600

          # Steady-state threshold
          # Allowed values:
          #  4  - absolute pod count (+/-)
          #  4% - percent change (+/-)
          #  -1 - disable the steady-state check
          Environment=STEADY_STATE_THRESHOLD=-1

          # Steady-state window = 60s
          # If the running pod count stays within the given threshold for this time
          # period, return CPU utilization to normal before the maximum wait time has
          # expires
          Environment=STEADY_STATE_WINDOW=60

          [Install]
          WantedBy=shutdown.target reboot.target halt.target
        enabled: true
        name: accelerated-container-shutdown.service
